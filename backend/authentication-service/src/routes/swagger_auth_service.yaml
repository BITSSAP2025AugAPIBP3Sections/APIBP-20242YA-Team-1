swagger: "2.0"
info:
  title: Google & Email/Password Authentication Service API
  version: 1.2.1
  description: >
    This service handles Google OAuth2 authentication flow and simple email/password registration & login.
host: localhost:4001
basePath: /api/v1
schemes:
  - http

servers:
  - url: http://localhost:4001/api/v1
    description: Local development server
    
paths:
  /api/v1/auth/google/login:
    get:
      summary: Generate Google OAuth2 Authorization URL
      description: Returns the Google OAuth2 consent screen URL where the user will log in.
      tags:
        - Google OAuth
      responses:
        "200":
          description: Authorization URL generated
          schema:
            type: object
            properties:
              auth_url:
                type: string

  /ap1/v1/auth/login:
    post:
      summary: Login with email and password
      tags:
        - Email Auth
      consumes:
        - application/json
      parameters:
        - in: body
          name: credentials
          required: true
          schema:
            type: object
            properties:
              email:
                type: string
              password:
                type: string
            required:
              - email
              - password
      responses:
        "200":
          description: Login successful (sets httpOnly access & refresh token cookies)
          schema:
            $ref: '#/definitions/EmailLoginSuccess'
        "400":
          description: Invalid credentials
          schema:
            $ref: '#/definitions/ErrorResponse'

  /api/v1/auth/register:
    post:
      summary: Register a new user with email, password, and username
      tags:
        - Email Auth
      consumes:
        - application/json
      parameters:
        - in: body
          name: user
          required: true
          schema:
            type: object
            properties:
              email:
                type: string
              password:
                type: string
              username:
                type: string
            required:
              - email
              - password
              - username
      responses:
        "201":
          description: User registered successfully. If auto-login succeeds returns tokens; otherwise returns a message.
          schema:
            $ref: '#/definitions/RegisterSuccess'
        "400":
          description: Registration failed
          schema:
            $ref: '#/definitions/ErrorResponse'

# IMPORTANT: Callback remains unversioned (basePath does NOT apply). Document separately.
# The live endpoint is /auth/callback outside /api/v1 for OAuth redirect URI stability.

  /api/v1/auth/logout:
    post:
      summary: Log out the authenticated user
      description: Removes auth cookies (access_token, refresh_token) and returns a message.
      tags:
        - Utility
      responses:
        "200":
          description: Logout successful
          schema:
            $ref: '#/definitions/MessageResponse'

  /api/v1//users/{user_id}:
    delete:
      summary: Delete a user by ID
      description: Permanently removes a user from the database.
      tags:
        - Users
      parameters:
        - name: user_id
          in: path
          required: true
          type: string
          description: User ID
      responses:
        "200":
          description: User deleted
          schema:
            $ref: '#/definitions/MessageResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/ErrorResponse'

  /api/v1/users:
    get:
      summary: List all users
      description: Returns an array of all registered users.
      tags:
        - Users
      responses:
        "200":
          description: Users fetched successfully
          schema:
            type: object
            properties:
              users:
                type: array
                items:
                  $ref: '#/definitions/User'

  /ap1/v1/auth/refresh:
    post:
      summary: Refresh access token
      description: Accepts a refresh token from cookie or request body and returns new access & refresh tokens.
      tags:
        - Utility
      consumes:
        - application/json
      parameters:
        - in: body
          name: refresh
          required: false
          schema:
            type: object
            properties:
              refresh_token:
                type: string
      responses:
        "200":
          description: Tokens refreshed successfully (sets new access_token cookie)
          schema:
            $ref: '#/definitions/TokensResponse'
        "400":
          description: Missing refresh token
          schema:
            $ref: '#/definitions/ErrorResponse'
        "401":
          description: Invalid or expired refresh token
          schema:
            $ref: '#/definitions/ErrorResponse'

  /api/v1/auth/me:
    get:
      summary: Get logged-in user
      description: Returns authenticated user info if access token is valid.
      tags:
        - Utility
      responses:
        "200":
          description: Auth state
          schema:
            type: object
            properties:
              isAuthenticated:
                type: boolean
              user:
                $ref: '#/definitions/User'

# Unversioned external OAuth path reference
x-unversioned-paths:
  /auth/callback:
    get:
      summary: Handle Google OAuth2 Callback (UNVERSIONED)
      description: Exchanges authorization code for tokens, verifies them, sets httpOnly cookies, and redirects to frontend.
      tags:
        - Google OAuth
      parameters:
        - name: code
          in: query
          required: true
          type: string
          description: Authorization code returned by Google
      responses:
        "302":
          description: "Redirect to frontend dashboard on successful authentication (cookies set: access_token, refresh_token)"
        "400":
          description: Invalid credentials or token
          schema:
            $ref: '#/definitions/ErrorResponse'

definitions:
  User:
    type: object
    properties:
      id:
        type: string
        example: 677e0bf8c5e4e3e5f8a1d234
      email:
        type: string
        example: user@example.com
      username:
        type: string
        example: johndoe
      google_id:
        type: string
        example: 108976234234234234234
      auth_provider:
        type: string
        example: google
      created_at:
        type: string
        example: 2025-11-03T10:15:00Z
  TokensResponse:
    type: object
    properties:
      access_token:
        type: string
      refresh_token:
        type: string
      token_type:
        type: string
        example: bearer
      user:
        $ref: '#/definitions/User'
  EmailLoginSuccess:
    type: object
    properties:
      tokens:
        $ref: '#/definitions/TokensResponse'
      email:
        type: string
        example: user@example.com
  RegisterSuccess:
    type: object
    description: Response after registration. If auto-login succeeds, tokens are present; otherwise only a message.
    properties:
      tokens:
        $ref: '#/definitions/TokensResponse'
      email:
        type: string
        example: user@example.com
      message:
        type: string
        example: Registered successfully, but login failed
  MessageResponse:
    type: object
    properties:
      message:
        type: string
        example: Operation successful
  ErrorResponse:
    type: object
    properties:
      error:
        type: string
        example: Invalid credentials

